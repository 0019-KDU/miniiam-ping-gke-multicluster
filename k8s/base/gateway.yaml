# =============================================================================
# Multi-Cluster Gateway API Configuration
# Deploy to MCI config cluster (gke-asia) only
#
# Architecture:
#   Internet → External LB → Gateway → Services
#
# Traffic Flow for OIDC:
#   User → PingAccess Engine → PingFederate Engine → PingDirectory
#        → React App / Backend API
# =============================================================================
apiVersion: gateway.networking.k8s.io/v1beta1
kind: Gateway
metadata:
  name: ping-iam-gateway
  namespace: ping-iam
  annotations:
    # Static IP from Terraform (load_balancer_ip)
    networking.gke.io/address-name: "ping-iam-external-ip"
spec:
  # GKE Multi-Cluster Gateway Class for external traffic
  gatewayClassName: gke-l7-global-external-managed-mc
  listeners:
    # HTTP listener (port 80)
    - name: http
      protocol: HTTP
      port: 80
      allowedRoutes:
        namespaces:
          from: Same

---
# =============================================================================
# HTTPRoute - Main Application Route
# All traffic goes through PingAccess Engine (API Gateway)
# PingAccess handles authentication and routes to backend services
# =============================================================================
apiVersion: gateway.networking.k8s.io/v1beta1
kind: HTTPRoute
metadata:
  name: pingaccess-main-route
  namespace: ping-iam
  labels:
    app.kubernetes.io/name: pingaccess-engine
    app.kubernetes.io/component: runtime
spec:
  parentRefs:
    - name: ping-iam-gateway
      namespace: ping-iam
  rules:
    # Route all traffic to PingAccess Engine
    # PingAccess will handle routing to React App, Backend API based on its config
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        # Multi-cluster Gateway requires ServiceImport (not Service)
        - group: net.gke.io
          kind: ServiceImport
          name: pingaccess-engine
          port: 3000

---
# =============================================================================
# HTTPRoute - PingFederate OIDC Endpoints
# Direct access to PingFederate for OIDC flows
# Path: /pf/*, /.well-known/*, /as/*
# =============================================================================
apiVersion: gateway.networking.k8s.io/v1beta1
kind: HTTPRoute
metadata:
  name: pingfederate-oidc-route
  namespace: ping-iam
  labels:
    app.kubernetes.io/name: pingfederate-engine
    app.kubernetes.io/component: runtime
spec:
  parentRefs:
    - name: ping-iam-gateway
      namespace: ping-iam
  rules:
    # OIDC well-known endpoint
    - matches:
        - path:
            type: PathPrefix
            value: /.well-known
      backendRefs:
        # Multi-cluster Gateway requires ServiceImport (not Service)
        - group: net.gke.io
          kind: ServiceImport
          name: pingfederate-engine
          port: 9031
    # PingFederate endpoints
    - matches:
        - path:
            type: PathPrefix
            value: /pf
      backendRefs:
        - group: net.gke.io
          kind: ServiceImport
          name: pingfederate-engine
          port: 9031
    # OAuth/OIDC Authorization Server endpoints
    - matches:
        - path:
            type: PathPrefix
            value: /as
      backendRefs:
        - group: net.gke.io
          kind: ServiceImport
          name: pingfederate-engine
          port: 9031

---
# =============================================================================
# GCPBackendPolicy - PingAccess Engine
# Configure backend to use HTTPS protocol for traffic
# =============================================================================
apiVersion: networking.gke.io/v1
kind: GCPBackendPolicy
metadata:
  name: pingaccess-engine-backend
  namespace: ping-iam
spec:
  default:
    securityPolicy: ""
    logging:
      enabled: true
      sampleRate: 1.0
  targetRef:
    group: net.gke.io
    kind: ServiceImport
    name: pingaccess-engine

---
# =============================================================================
# HealthCheckPolicy - PingAccess Engine
# Configure GCP health check to use HTTPS and correct endpoint
# =============================================================================
apiVersion: networking.gke.io/v1
kind: HealthCheckPolicy
metadata:
  name: pingaccess-engine-healthcheck
  namespace: ping-iam
spec:
  default:
    checkIntervalSec: 15
    timeoutSec: 5
    healthyThreshold: 2
    unhealthyThreshold: 3
    logConfig:
      enabled: true
    config:
      type: HTTPS
      httpsHealthCheck:
        port: 3000
        requestPath: /pa/heartbeat.ping
  targetRef:
    group: net.gke.io
    kind: ServiceImport
    name: pingaccess-engine

---
# =============================================================================
# HealthCheckPolicy - PingFederate Engine
# Configure GCP health check to use HTTPS and correct endpoint
# =============================================================================
apiVersion: networking.gke.io/v1
kind: HealthCheckPolicy
metadata:
  name: pingfederate-engine-healthcheck
  namespace: ping-iam
spec:
  default:
    checkIntervalSec: 15
    timeoutSec: 5
    healthyThreshold: 2
    unhealthyThreshold: 3
    logConfig:
      enabled: true
    config:
      type: HTTPS
      httpsHealthCheck:
        port: 9031
        requestPath: /pf/heartbeat.ping
  targetRef:
    group: net.gke.io
    kind: ServiceImport
    name: pingfederate-engine
