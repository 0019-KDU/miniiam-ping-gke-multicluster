# =============================================================================
# PingDirectory Helm Values - GKE-ASIA (SEED CLUSTER)
# Chart: pingidentity/ping-devops
# Purpose: Multi-master replication seed for cross-cluster topology
# =============================================================================

global:
  addReleaseNameToResource: none
  envs:
    PING_IDENTITY_ACCEPT_EULA: "YES"
  secretEnvs:
    - secretRef:
        name: devops-secret
  image:
    repository: pingidentity
    pullPolicy: IfNotPresent
    tag: "2512"
  ingress:
    enabled: false
  labels:
    app.kubernetes.io/part-of: ping-iam

# Disable other Ping products
pingfederate-admin:
  enabled: false
pingfederate-engine:
  enabled: false
pingaccess-admin:
  enabled: false
pingaccess-engine:
  enabled: false

# =============================================================================
# PingDirectory Configuration
# =============================================================================
pingdirectory:
  enabled: true
  name: pingdirectory

  # ---------------------------------------------------------------------------
  # Workload Configuration
  # ---------------------------------------------------------------------------
  workload:
    type: StatefulSet
    annotations:
      sidecar.istio.io/inject: "true"
      proxy.istio.io/config: '{"holdApplicationUntilProxyStarts": true}'
      traffic.sidecar.istio.io/excludeInboundPorts: "1389,1636,8989,15020"
      traffic.sidecar.istio.io/excludeOutboundPorts: "1389,1636,8989"

  # ---------------------------------------------------------------------------
  # Container Configuration
  # ---------------------------------------------------------------------------
  container:
    replicaCount: 1
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 2
        memory: 2Gi

    # CRITICAL: Probe configuration for PingDirectory
    # NOTE: readinessProbe is handled by post-renderer (kustomize patch)
    #       to use httpGet with /available-or-degraded-state endpoint
    probes:
      livenessProbe:
        exec:
          command:
            - /opt/liveness.sh
        httpGet: null
        initialDelaySeconds: 30
        periodSeconds: 30
        timeoutSeconds: 5
        successThreshold: 1
        failureThreshold: 4
      readinessProbe:
        exec:
          command:
            - /opt/readiness.sh
        httpGet: null
        initialDelaySeconds: 30
        periodSeconds: 30
        timeoutSeconds: 5
        successThreshold: 1
        failureThreshold: 4
      startupProbe:
        exec:
          command:
            - /opt/liveness.sh
        httpGet: null
        initialDelaySeconds: 30
        periodSeconds: 10
        timeoutSeconds: 5
        successThreshold: 1
        failureThreshold: 180

  # ---------------------------------------------------------------------------
  # Environment Variables
  # ---------------------------------------------------------------------------
  envs:
    # ===== CLUSTER IDENTIFICATION =====
    K8S_CLUSTER: "gke-asia"
    K8S_SEED_CLUSTER: "gke-asia"
    K8S_CLUSTERS: "gke-asia,gke-europe"
    K8S_POD_HOSTNAME_PREFIX: "pingdirectory-"
    # GKE Fleet uses cluster-specific domain, not cluster.local
    K8S_POD_HOSTNAME_SUFFIX: ".pingdirectory-cluster.ping-iam.svc.gke-asia.local"
    PD_CLUSTER_NAME: "gke-asia"

    # ===== LDAP CONFIGURATION =====
    ROOT_USER_DN: "cn=administrator"
    ROOT_USER_PASSWORD: "2FederateM0re"
    USER_BASE_DN: "dc=example,dc=com"
    MAX_HEAP_SIZE: "768m"

    # ===== PORT CONFIGURATION =====
    LDAP_PORT: "1389"
    LDAPS_PORT: "1636"
    REPLICATION_PORT: "8989"
    HTTPS_PORT: "1443"

    # ===== REPLICATION SETTINGS =====
    ORCHESTRATION_TYPE: "KUBERNETES"

  # ---------------------------------------------------------------------------
  # Service Configuration
  # ---------------------------------------------------------------------------
  services:
    ldap:
      servicePort: 1389
      containerPort: 1389
      dataService: true
    ldaps:
      servicePort: 1636
      containerPort: 1636
      dataService: true
    https:
      servicePort: 1443
      containerPort: 1443
      dataService: true
    replication:
      servicePort: 8989
      containerPort: 8989
      clusterService: true

  # ---------------------------------------------------------------------------
  # Persistent Volume Configuration
  # ---------------------------------------------------------------------------
  persistentvolume:
    enabled: true
    volumes:
      out:
        mountPath: /opt/out
        persistentVolumeClaim:
          accessModes:
            - ReadWriteOnce
          storageClassName: standard-rwo
          resources:
            requests:
              storage: 5Gi
